<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
    <!-- <p><small>A link to the Home page</small> <a href = ./index.html><small>Home</small></a></p> -->
<body>

<script type="text/javascript">
const width  = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
const height = window.innerHeight|| document.documentElement.clientHeight|| document.body.clientHeight;
console.log(height+" "+ width)
var config = {
    type: Phaser.AUTO,
    width: width,
    height: height,
    backgroundColor: '000000',
    physics: {
        default: 'arcade',
        arcade: {
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
    
};

var snake = [];
var head;
var body;
var won = false;
var apple;
var touchTrue = true;
var ylast= 0;
var ytemp= 0;
var xlast= 0;
var xtemp= 0;
var horizontal = false;
var vertical = false;
up = false;
right = false;
left = false;
down = false;
const d = new Date();
var lastY = 0;
var tempY = 0;
var cursors;
var score = 0;
var gameOver = false;
var scoreText

var game = new Phaser.Game(config);

function preload ()
{
    //this.load.image('head', 'assets/snakeHead.png');
    this.load.image('body', 'assets/snakeBody.png');
    //this.load.image('turn', 'assets/turnpoint.png');
    this.load.image('apple', 'assets/apple.png');
}

function create ()
{
    head = this.physics.add.image(width/17*8+width/34, height/15*7+height/15, 'body');
    head.setScale(width/17/head.height);
    apple = this.physics.add.image(width/17*(Math.floor(Math.random()*17))+width/34, height/15*(Math.floor(Math.random()*15))+height/15, 'apple');
    apple.setScale(width/17/apple.height);
    //  Input Events
    cursors = this.input.keyboard.createCursorKeys();
    body = this.physics.add.group();

    //  The score
    scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#ffffff' });
    
    snake.push(head);

    this.physics.add.collider(apple, head, scored, null, this);
    // this.physics.add.collider(head, body, hitSelf, null, this);
    // xlast = head.x;
    // ylast = head.y;
}

function update ()
{
    if(gameOver){
        if(won){
            scoreText.setText('You Won!');
        gameOver = true;
        return; 
        }
        scoreText.setText('You Lose!');
        gameOver = true;
        return;
    }
    t = -1;
    var d = new Date();
    var j = d.getMilliseconds();
    while(t!=((j+250)%1000)){
        var s = new Date()
        t = s.getMilliseconds();
    }
    if(cursors.up.isDown&&!vertical){
        lastY = 0;
        tempY = -2*(height/15);//-5;
        xlast = 0;//
        ylast =5//ylast+=5;
        up = true;
        down = false;
        left = false;
        right = false;
        vertical = true;
        horizontal = false;
    }else if(cursors.down.isDown&&!vertical){
        lastY = 0;
        tempY = 2*(height/15);//+5;
        ylast=-5//ylast-=5;
        xlast = 0;
        up = false;
        down = true;
        left = false;
        right = false;
        vertical = true;
        horizontal = false;
    }else if(cursors.right.isDown&&!horizontal){
        lastY = width/17;//+5;
        xlast=-5//xlast-=5
        ylast=0;
        tempY = 0;
        up = false;
        down = false;
        left = false;
        right = true;
        vertical = false;
        horizontal = true;
    }else if(cursors.left.isDown&&!horizontal){
        lastY = -1*(width/17);//-5;
        xlast=5//xlast+=5;
        ylast = 0;
        tempY = 0;
        up = false;
        down = false;
        left = true;
        right = false;
        vertical = false;
        horizontal = true;
    }
    head.x+=lastY+xlast;
    head.y+=tempY+ylast;
    for(var i = 0; i<snake.length; i++){
        if(snake[i]!=head){
            
            xtemp = snake[i].x;
            ytemp = snake[i].y;
            
            //snake[i].x = xlast;
            //snake[i].y = ylast;

            if(ylast >0){
                snake[i].y = snake[i-1].y+width/17+5;
                snake[i].x = snake[i-1].x;
            }
            if (ylast < 0){
                snake[i].y = snake[i-1].y-width/17-5
                snake[i].x = snake[i-1].x;
            }
            if (xlast > 0){
                snake[i].x = snake[i-1].x+width/17+5;
                snake[i].y = snake[i-1].y;
            }
            if (xlast < 0){
                snake[i].x = snake[i-1].x-width/17-5
                snake[i].y = snake[i-1].y;
            }

            // if(snake[i].y-snake[i-1].y<(width/17)/2&&snake[i].y-snake[i-1].y>-1*((width/17)/2)){
            //     snake[i].y = snake[i-1].y;
            // }
            // if(snake[i].x-snake[i-1].x<(width/17)/2&&snake[i].x-snake[i-1].x>-1*((width/17)/2)){
            //     snake[i].x = snake[i=1].x;
            // }
            // if(i!=snake.length-1){
            //     if(snake[i].y-snake[i+1].y<(width/17)/2&&snake[i].y-snake[i+1].y>-1*((width/17)/2)){
            //         snake[i].y = snake[i+1].y;
            //     }
            //     if(snake[i].x-snake[i+1].x<(width/17)/2&&snake[i].x-snake[i+1].x>-1*((width/17)/2)){
            //         snake[i].x = snake[i+1].x;
            //     }
            // }
            // if(snake[i].y-snake[i-1].y<(width/17)&&snake[i].y-snake[i-1].y>-1*((width/17)/2)&&snake[i].x-snake[i-1].x>width/17+5||snake[i].X-snake[i-1].x<-1*((width/17)-5)){
            //     if(snake[i].x-snake[i-1].x<0){
            //         snake[i].x = snake[i].x+(width/17)+5;
            //     }else if(snake[i].x-snake[i-1].x>0){
            //         snake[i].x = snake[i].x-(width/17)-5;
            //     }
            // }
            // if(snake[i].x-snake[i-1].x<(width/17)&&snake[i].x-snake[i-1].x>-1*((width/17)/2)&&snake[i].y-snake[i-1].y>width/17+5||snake[i].y-snake[i-1].y<-1*((width/17)-5)){
            //     if(snake[i].y-snake[i-1].y<0){
            //         snake[i].y = snake[i-1].y-(width/17)-5;//snake[i].y+(width/17)+5;
            //     }else if(snake[i].y-snake[i-1].y>0){
            //         snake[i].y = snake[i-1].y+(width/17)+5;//snake[i].y-(width/17)-5;
            //     }
            // }

            // if(snake[i].x!=snake[i-1].x&&snake[i].y-snake[i-1].y>10||snake[i].y-snake[i-1].y<-10){
            //     //var dif = snake[i].x-snake[i-1].x;
            //     snake[i].x = snake[i-1].x;
            //     //snake[i-1].y = snake[i].y;
            //     for(var j = i+1; j<snake.length-1; j++){
            //         if(snake[j-1].y == snake[j+1].y){
            //             snake[j].x=(snake[j-1].x+snake[j+1].x)/2;   
            //         }
                    
            //     }
            // }else if(snake[i].y!=snake[i-1].y&&snake[i].x-snake[i-1].x>10||snake[i].x-snake[i-1].x<-10){
            //     //var dif = snake[i].y-snake[i-1].y;
            //     snake[i].y = snake[i-1].y;
            //     //snake[i-1].y = snake[i].y;
            //     for(var j = i+1; j<snake.length-1; j++){
            //         if(snake[j-1].x == snake[j+1].x){
            //             snake[j].y=(snake[j-1].y+snake[j+1].y)/2;    
            //         }
            //     }
            // }  
            
           // xlast = xtemp;
            //ylast = ytemp;
            if(ytemp === snake[i].y){
                if(xtemp<snake[i].x){
                    xlast=-1;
                    ylast = 0;
                }else{
                    xlast=1;
                    ylast = 0;
                }
            }else if (xtemp === snake[i].x){
                if(ytemp<snake[i].y){
                    ylast=-1;
                    xlast = 0;
                }else{
                    ylast=1;
                    xlast = 0;
                }
            }else if(snake[i].x === snake[i-1].x){
                if(xtemp<snake[i].x){
                    xlast=-1;
                    ylast = 0;
                }else{
                    xlast=1;
                    ylast = 0;
                }
            }else if(snake[i.y === snake[i-1].y]){
                if(ytemp<snake[i].y){
                    ylast=-1;
                    xlast = 0;
                }else{
                    ylast=1;
                    xlast = 0;
                }
            }else{
                console.log("An error occured");
                if(ytemp<snake[i].y){
                    ylast=-1;
                    xlast = 0;
                }else if(ytemp>snake[i].y){
                    ylast=1;
                    xlast = 0;
                }else if(xtemp<snake[i].x){
                    xlast=-1;
                    ylast = 0;
                }else if(xtemp>snake[i].x){
                    xlast=1;
                    ylast = 0;
                }
            }
            // if(i==1){
            //     if(snake[i].x<snake[0].x){
            //         snake[i].x-=5;
            //     }else if (snake[i].x>snake[0].x){
            //         snake[i].x+=5;
            //     }
            // }
        }
    }
    if(head.y>height-(width/17)/2+1||head.y<0+(width/17)/2-1||head.x>width-(width/17)/2+1||head.x<0+(width/17)/2-1){
        scoreText.setText('You Lose!');
        gameOver = true;
        return;
    }
    if(up){
        ylast = 5;
        xlast = 0;
    }
    if(down){
        ylast = -5;
        xlast = 0;
    }
    if(right){
        ylast = 0;
        xlast = -5;
    }
    if (left){
        ylast = 0;
        xlast = 5;
    }
    
}

function scored ()
{  
    if(gameOver){
        return;
    }
    if(snake.length===15*17){
        scoreText.setText('You Won!');
        gameOver = true;
        won = true;
        return;
    }
    score++;
    scoreText.setText('Score: ' + score);
    apple.x = width/17*(Math.floor(Math.random()*17))+width/34;
    apple.y = height/15*(Math.floor(Math.random()*15))+height/15;
    apple.setVelocity(0, 0);
    var bod = body.create(snake[snake.length-1].x, snake[snake.length-1].y, 'body');
    bod.setScale(width/17/head.height);
    snake.push(bod);
}

function hitSelf(){
    if(!touchTrue){
        touchTrue = true;
        return;
    }
    gameOver = true;
}

</script>

</body>
</html>